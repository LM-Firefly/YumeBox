name: Smart Release

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: Smart-Release
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '25'
          cache: 'gradle'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_SDK_ROOT }}/ndk/29.0.14206865
          key: ndk-29.0.14206865

      - name: Install NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: sdkmanager "ndk;29.0.14206865"

      - name: Update CA certificates
        run: |
          sudo apt-get update && sudo apt-get install -y ca-certificates
          sudo update-ca-certificates
          mkdir -p core/src/foss/golang/mihomo/component/ca
          cp -f /etc/ssl/certs/ca-certificates.crt core/src/foss/golang/mihomo/component/ca/ca-certificates.crt

      - name: Sync kernel
        run: |
          chmod +x scripts/sync-kernel.sh
          ./scripts/sync-kernel.sh smart

      - name: Write signing config
        run: |
          if [ -n "${{ secrets.SIGNING_STORE_PASSWORD }}" ]; then
            echo "keystore.password=${{ secrets.SIGNING_STORE_PASSWORD }}" > signing.properties
            echo "key.alias=${{ secrets.SIGNING_KEY_ALIAS }}" >> signing.properties
            echo "key.password=${{ secrets.SIGNING_KEY_PASSWORD }}" >> signing.properties
            echo "keystore.path=release.keystore" >> signing.properties
          fi

      - name: Inject google-services.json
        run: |
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo "Using real google-services.json from secrets"
            echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json
          else
            echo "Creating dummy google-services.json for PR/Fork builds"
            cat > app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "dummy-project",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                  "android_client_info": {
                    "package_name": "com.github.yumelira.yumebox"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "AIzaDummyKeyForBuildOnly-0000000000000"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF
          fi

      - name: Build Release APKs
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon assembleRelease

      - name: Delete existing Smart release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取 Smart release
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/Smart --jq '.id' 2>/dev/null || echo "")
          
          if [ -n "$RELEASE_ID" ]; then
            echo "Found Smart release (ID: $RELEASE_ID), deleting assets..."
            
            # 获取所有资源并删除
            gh api repos/${{ github.repository }}/releases/$RELEASE_ID/assets --jq '.[].id' | while read ASSET_ID; do
              echo "Deleting asset $ASSET_ID..."
              gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID
            done
            
            echo "All assets deleted"
          else
            echo "Smart release not found, will create new one"
          fi

      - name: Create or update Smart release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 尝试获取 Smart release
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/Smart --jq '.id' 2>/dev/null || echo "")
          
          if [ -n "$RELEASE_ID" ]; then
            echo "Updating existing Smart release..."
            gh api -X PATCH repos/${{ github.repository }}/releases/$RELEASE_ID \
              -f name="Smart" \
              -f body="" \
              -F prerelease=true
          else
            echo "Creating new Smart release..."
            gh release create Smart \
              --title "Smart" \
              --notes "" \
              --prerelease
          fi

      - name: Upload APKs to Smart release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 上传所有 APK
          for apk in app/build/outputs/apk/release/*.apk; do
            if [ -f "$apk" ]; then
              echo "Uploading $(basename $apk)..."
              gh release upload Smart "$apk" --clobber
            fi
          done
          
          echo "All APKs uploaded to Smart release"
